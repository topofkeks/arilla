#include "peripheral.h"

#define STACK_SIZE 256

unsigned int stack[STACK_SIZE]=
{
0b00000000000000000000000000000000,0b00000000000000000000000000000000,0b00000000000000000000000000001111,0b11111100000000000000000000000000,
0b00000000000000000000001111111111,0b11100000000000000000000000000000,0b00000000000000000000000001111111,0b11111111100000000000000000000000,
0b00000000000000000000111111111111,0b11111100000000000000000000000000,0b00000000000000000000000011111111,0b11111111110000000000000000000000,
0b00000000000000000111111111111111,0b11111111000000000000000000000000,0b00000000000000000000001111111111,0b11111111111100000000000000000000,
0b00000000000000011111111111111111,0b11111111100000000000000000000000,0b00000000000000000000011111111111,0b11111111111110000000000000000000,
0b00000000000001111111111111111011,0b01100001110000000000000000000000,0b00000000000000000000111111111111,0b11111111111111000000000000000000,
0b00000000000001111111111111111101,0b11010100011000000000000000000000,0b00000000000000000001111111111111,0b11111111111111110000000000000000,
0b00000000000001111111111111101011,0b10101000000100000000000000000000,0b00000000000000000011111111111111,0b11111111111111111000000000000000,
0b00000000000011111111111101111101,0b01010010100110000000000000000000,0b00000000000000000111111111111111,0b11111111111111111100000000000000,
0b00000000000111111111101111101101,0b01010000010011000000000000000000,0b00000000000000001111111111111111,0b11111111111111111110000000000000,
0b00000000001111111111111011111010,0b10100101000001100000000000000000,0b00000000000000011111111111111111,0b11111111111111111111000000000000,
0b00000000011111111111011111010101,0b01001000010100110000000000000000,0b00000000000000010111111111111111,0b11111111111111111111110000000000,
0b00000000111111101010110101101100,0b10100010100000010000000000000000,0b00000000000000101111111111111111,0b11111111111111111111110000000000,
0b00000001111111111111010110100101,0b00010000010101011000000000000000,0b00000000000000101111111111111111,0b11111111111111111111111000000000,
0b00000001111111110100101001011010,0b01000101000000001000000000000000,0b00000000000001011111111111111111,0b11111111111111111111111100000000,
0b00000011111111111101001010100000,0b10001000001010101100000000000000,0b00000000000000111111111111111111,0b11111111111111111111111100000000,
0b00000111111111110010100100001010,0b00100010100000001100000000000000,0b00000000000011111111111111111111,0b11111111111111111111111110000000,
0b00000111111111111001010010100001,0b00010000010101000110000000000000,0b00000000000000111111111111111111,0b11111111111111111111111110000000,
0b00000111111111110110001000010100,0b01000101000000010010000000000000,0b00000000000011111111111111111111,0b11111111111111111111111111000000,
0b00000111111111101001010101000000,0b10001000001010100110000000000000,0b00000000000001111111111111111111,0b11111111111111111111111111000000,
0b00001111111111110100100010010101,0b00100010100000001010000000000000,0b00000000000111111111111111100000,0b01111111111111111111111110000000,
0b00001111111111101010011001000000,0b10010000010101000110000000000000,0b00000000000011111111111110000000,0b00101111111111111111111110000000,
0b00001111111111110101100010101010,0b01000101000000101110000000000000,0b00000000000111111111111100000101,0b00011011111111111111111110000000,
0b00001111111111101010001101000000,0b10001000010101011100000000000000,0b00000000000111111111111000010000,0b00100101011111111111111110000000,
0b00001111111111110101100010010101,0b00100010100010111010000000000000,0b00000000001111111111110000000000,0b10001001010101111111111110000000,
0b00001111111111111010011001001000,0b10010000010101110100000000000000,0b00000000001111111111100000000000,0b01000100101010111111111110000000,
0b00001111111111111101100010100010,0b01000101001010101010000000000000,0b00000000000111111111000010000000,0b00010001010101011111111110000000,
0b00001111111111110101001101010100,0b10010010010101010111000000000000,0b00000000001111111111001000010000,0b00100010001010110011111100000000,
0b00001111111111111110110010001001,0b00000101101010100110000000000000,0b00000000001111111110000010101100,0b10001001010101101111111000000000,
0b00001111111111111011011010100100,0b10101111110101100010100000000000,0b00000000001111111100010000010110,0b01000100100100110111111000000000,
0b00011111111111111101110100101010,0b01011110001010011110000000000000,0b00000000000111111110000101001001,0b10110001011011011011111000000000,
0b00011111111111111111101101010100,0b11111001111000101001010000000000,0b00000000001111111100000010000011,0b01000010111111110111111000000000,
0b00011111111111111111110010101011,0b11100111000101001010000000000000,0b00000000001001111000000001111110,0b10000101110101011111110000000000,
0b00011111111111111111011001010101,0b01010111101010100101010000000000,0b00000000001000111100000000011111,0b10000011100010101011110000000000,
0b00011111111111111111100110101011,0b10110110101010010010100000000000,0b00000000000100111000000000000010,0b10000001111111110111110000000000,
0b00011111111111111111011001010110,0b01100001010010100100010000000000,0b00000000000101000000000000100101,0b00000111111111111011110000000000,
0b00011111111111111111100110101001,0b11001111001001001001000000000000,0b00000000000100000000000000001000,0b00010011110111101111100000000000,
0b00011111111111111111110001010100,0b00110100100101010100100000000000,0b00000000000110000000000000100000,0b00000101111001110111110000000000,
0b00011111111111111111111110101010,0b10001010010010100010010000000000,0b00000000000110001000000000001010,0b00000011011110001011100000000000,
0b00011111111111111111111001010000,0b00010000100101010100100000000000,0b00000000000010010000000000010000,0b01000010111010110111100000000000,
0b00001111111111111111110100101010,0b10000101001010100001010000000000,0b00000000000010001000000000000101,0b00001011101101001111000000000000,
0b00001111111111111111111110010100,0b00101010100101011000101000000000,0b00000000000011000000000000101010,0b00000101110110100110000000000000,
0b00000111111101101100111101101010,0b10000100001010010110101000000000,0b00000000000001010100000000001010,0b00000010111101010110000000000000,
0b00000111111101000001110101010101,0b00101001010101111011011000000000,0b00000000000001000000000010110000,0b11100101110101010100000000000000,
0b00000111111100010110011110101010,0b10100100100010010111111000000000,0b00000000000010010100000001000001,0b00011111111101010100000000000000,
0b00000111111110101010101010100101,0b01010010010101101110111000000000,0b00000000001110000000000101101000,0b10101111111110101100000000000000,
0b00000111111111001001001101011010,0b10010100100010011011001100000000,0b00000000011111010000000010110111,0b10100111011101010100000000000000,
0b00001111111111010010011011010101,0b00100101001010110100111100000000,0b00000000011110010100000011101000,0b00101111111010101100000000000000,
0b00000101111111110100101110110101,0b01010100101011010111001000000000,0b00000000111110100000100100010111,0b01001011111101011000000000000000,
0b00000111111111111100010111011010,0b10101010010101101010101100000000,0b00000000111110011010000000000001,0b11110110111110101000000000000000,
0b00000001111111111111111101110111,0b01010010101111010101010100000000,0b00000000111111010101010000000000,0b00011111111101011000000000000000,
0b00000011111111111001001011101110,0b11010101011010101010111100000000,0b00000000111110001010000001000000,0b10100111111101110000000000000000,
0b00100101111111010010011011011011,0b01101010110101010111101000000000,0b00000001111111011101101000000010,0b01011101110111110000000000000000,
0b00000000111111101001011101110101,0b10110101011010101111101100000000,0b00000001111111001110100100000001,0b01000110110101110000000000000000,
0b00000000111100010010011010111111,0b01101101010101011011010100000000,0b00000001111111100111010001000000,0b10111011011111100000000000000000,
0b00000000101001100100011111101110,0b11011011110101010110101100100000,0b00000001111111100111110110000000,0b00000110111011100000000000000000,
0b00100010000000000001011001011101,0b10110110101110101001111100000000,0b00000011111111110011101001010000,0b10010101101111000000000000000000,
0b00000000001010100100011110110111,0b11011011010101010101011000000000,0b00000011111111110011110111100000,0b10011110111110000000000000000000,
0b00010000000000000001001111011111,0b01101101111110111011111100100100,0b00000111111111111001111101111101,0b10101011111110000000000000000000,
0b00000001000100010010000110110110,0b11111011011101010111111000000000,0b00001111111111111100111111111011,0b01011111111110000000000000000000,
0b00010000000010100000101111011101,0b10111111110110111101110000000000,0b00011111111111111100011110111111,0b11111111111111000000000000000000,
0b01001000000010000000000011101010,0b11111111111111111111100001000000,0b01111111111111111101000111111111,0b11111111111111100000000000000000,
0b00000100010001001001010001011111,0b01010111111111111110000000000000,0b11111111111111111100101001111111,0b11111101111111100000000000000000,
0b00000000000000000000000001110010,0b11010101011111110000000000000000,0b11111111111111111110100010111011,0b11111101111111110000000000000000
};

unsigned int sp=0;

void pop(point* p)
{
    p->x=stack[--sp]&MOUSE_POSITION_MASK;
    p->y=stack[sp]>>10;
}

void push(unsigned int x,unsigned int y)
{
    if(sp!=STACK_SIZE)
    {
        stack[sp++]=(y<<10)|(x&MOUSE_POSITION_MASK);
    }
}

void drawIcon(unsigned int x,unsigned int y,unsigned int zCol,unsigned int oCol,const unsigned int icon[])
{
    for(int i=0;i<32;i++)
    {
        unsigned int row=icon[i];
        for(int j=31;j>=0;j--)
        {
            gpuDrawPoint_c(x+j,y+i,row%2==0?zCol:oCol);
            row>>=1;
        }
    }
}

void drawIconOpt(unsigned int x,unsigned int y,unsigned int col,const unsigned int icon[],unsigned int bgVal)
{
    for(int i=0;i<32;i++)
    {
        unsigned int row=icon[i];
        for(int j=31;j>=0;j--)
        {
            if(row%2!=bgVal)
            {
                gpuDrawPoint_c(x+j,y+i,col);
            }
            row>>=1;
        }
    }
}

void EE()
{
    for(int i=0;i<64;i++)
    {
        for(int k=0;k<4;k++)
        {
            unsigned int row=stack[(i*4)+k];
            for(int j=31;j>=0;j--)
            {
                if(row%2)
                {
                    gpuDrawPoint_c((k*32)+j,i,COLOR_BLACK);
                }
                row>>=1;
            }
        }
    }
}

void AL()
{
    for(int i=0;i<32;i++)
    {
        for(int k=0;k<4;k++)
        {
            unsigned int row=ICON_ARILLA[(i*4)+k];
            for(int j=15;j>=0;j--)
            {
                switch(row%4)
                {
                    case 1:{gpuDrawPoint_c(704+(k*16)+j,568+i,0x024);break;}
                    case 2:{gpuDrawPoint_c(704+(k*16)+j,568+i,COLOR_WHITE);break;}
                    case 3:{gpuDrawPoint_c(704+(k*16)+j,568+i,0xF11);break;}
                    default:{break;}
                }
                row>>=2;
            }
        }
    }
}

void ALUS()
{
    for(int i=0;i<32;i++)
    {
        for(int k=0;k<4;k++)
        {
            unsigned int row=ICON_ARILLA[(i*4)+k];
            for(int j=15;j>=0;j--)
            {
                switch(row%4)
                {
                    case 1:{gpuFillRect_c(272+(k*64)+j*4,104+i*4,275+(k*64)+j*4,107+i*4,0x024);break;}
                    case 2:{gpuFillRect_c(272+(k*64)+j*4,104+i*4,275+(k*64)+j*4,107+i*4,COLOR_WHITE);break;}
                    case 3:{gpuFillRect_c(272+(k*64)+j*4,104+i*4,275+(k*64)+j*4,107+i*4,0xF11);break;}
                    default:{break;}
                }
                row>>=2;
            }
        }
    }
}

void floodFill(unsigned int x,unsigned int y,unsigned int dst)
{
    unsigned int src=gpuGetColor(x,y);
    if(src==dst){return;}
    push(x,y);

    point p;
    unsigned int setabove;
    unsigned int setbelow;
    unsigned int setsecondabove;
    unsigned int setsecondbelow;
    unsigned int minx;
    unsigned int maxx;

    while (sp != 0)
    {
        pop(&p);
        if (gpuGetColor(p.x, p.y) == src)
        {
            setabove = 0;
            setbelow = 0;
            setsecondabove = 0;
            setsecondbelow = 0;
            minx = p.x - 1;
            maxx = p.x + 1;

            //LOOP UNROLLING
            if ((p.y - 1) < 600 - 64)
            {
                if (gpuGetColor(p.x, p.y - 1) == src)
                {
                    push(p.x, p.y - 1);
                    setbelow = 1;
                    setsecondbelow = 1;
                }
            }
            if ((p.y + 1) < 600 - 64)
            {
                if (gpuGetColor(p.x, p.y + 1) == src)
                {
                    push(p.x, p.y + 1);
                    setabove = 1;
                    setsecondabove = 1;
                }
            }

            while (minx < 800 && gpuGetColor(minx, p.y) == src)
            {
                if ((p.y - 1) < 600 - 64)
                {
                    if (gpuGetColor(minx, p.y - 1) == src)
                    {
                        if (!setbelow)
                        {
                            push(minx, p.y - 1);
                            setbelow = 1;
                        }
                    }
                    else
                    {
                        setbelow = 0;
                    }
                }
                if ((p.y + 1) < 600 - 64)
                {
                    if (gpuGetColor(minx, p.y + 1) == src)
                    {
                        if (!setabove)
                        {
                            push(minx, p.y + 1);
                            setabove = 1;
                        }
                    }
                    else
                    {
                        setabove = 0;
                    }
                }
                minx--;
            }
            minx++;
            while (maxx < 800 && gpuGetColor(maxx, p.y) == src)
            {
                if ((p.y - 1) < 600 - 64)
                {
                    if (gpuGetColor(maxx, p.y - 1) == src)
                    {
                        if (!setsecondbelow)
                        {
                            push(maxx, p.y - 1);
                            setsecondbelow = 1;
                        }
                    }
                    else
                    {
                        setsecondbelow = 0;
                    }
                }
                if ((p.y + 1) < 600 - 64)
                {
                    if (gpuGetColor(maxx, p.y + 1) == src)
                    {
                        if (!setsecondabove)
                        {
                            push(maxx, p.y + 1);
                            setsecondabove = 1;
                        }
                    }
                    else
                    {
                        setsecondabove = 0;
                    }
                }
                maxx++;
            }
            maxx--;
            if (minx == maxx)
            {
                gpuDrawPoint(minx, p.y);
            }
            else
            {
                gpuDrawLine(minx, p.y, maxx, p.y);
            }
        }
    }
}
